<?php

class Kneipe {
    private $id;
    private $name;
    private $art;
    private $bewertung;

    public function __construct($id = null) {
        if ($id !== null) {
            $this->id = $id;
            $this->load();
        }
    }

    public function getId() {
        return $this->id;
    }

    public function getName() {
        return $this->name;
    }

    public function getArt() {
        return $this->art;
    }

    public function load() {
        $db = Database2::getInstance();
        $q = $db->q('SELECT * FROM %pkneipen WHERE knid = %i', $this->id);

        if ($q->hasData()) {
            $this->id = $q->getFirst()->knid;
            $this->name = $q->getFirst()->name;
            $this->art = new Kneipenart($q->getFirst()->kaid);
            $this->bewertung = new Bewertung($q->getFirst()->knid);
        }

        return $q->hasData();
    }

    public static function getKneipeByName($name) {
        $db = Database2::getInstance();

        $q = $db->q('SELECT knid FROM %pkneipen WHERE name = %s', $name);
        if ($q->hasData()) {
            return new Kneipe($q->getFirst()->knid);
        } else {
            return false;
        }
    }

    public static function addKneipe($name, $note, $type, $comment) {
        $db = Database2::getInstance();

        $q = $db->q(
            'INSERT INTO %pkneipen (name, kaid) VALUES (%s, %i)
            ON DUPLICATE KEY UPDATE kaid = %i', 
            $name, $type, $type
        );
        if ($q->getStatus()) {
            $id = $db->getlastInsertId();
            if ($id <= 0) {
                // It was an update 
                $kneipe = Kneipe::getKneipeByName($name);
                $id = $kneipe === false ? 0 : $kneipe->getId();
            }

            if ($id > 0) {
                Bewertung::addBewertung($id, $note, $comment);
            } else {
                $q->setStatus(false);
            }
        }

        return $q->getStatus();
    }

    public static function getKneipen($search = null) {
        $db = Database2::getInstance();
        $data = array();

        syslog(LOG_INFO, 'Results: ' . print_r($search, true));
        if ($search !== null && is_string($search)) {
            $search = explode(' ', $search);
            $searchReg = '.*(';
            for ($i = 0; $i < count($search); $i++) {
                $searchReg .= $search[$i] . (($i < count($search) - 1) ? '|' : '') ;
            }
            $searchReg .= ').*'; 
        } else {
            $search = null;
        }

        if ($search == null) {
            $q = $db->q('SELECT knid FROM %pkneipen ORDER BY name');
        } else {
            $q = $db->q(
                'SELECT k.knid FROM %pkneipen k 
                JOIN %pbewertungen b ON b.knid = k.knid 
                JOIN %pkneipenarten ka ON ka.kaid = k.kaid
                WHERE k.name REGEXP %s OR
                b.note REGEXP %s OR 
                b.comment REGEXP %s OR
                ka.typeName REGEXP %s
                GROUP BY k.knid 
                ORDER BY k.name',
                $searchReg, $searchReg, $searchReg, $searchReg
            );
            syslog(LOG_INFO, 'Results: ' . $q->getStatement());
        }
        if ($q->hasData()) {
            foreach ($q->getData() as $v) {
                $data[] = new Kneipe($v->knid);
            }
        }

        return $data;
    }

    public function remove() {
        // Not implemented
    }

    /**
     * Class casting
     *
     * @param string|object $destination
     * @param object $sourceObject
     * @return object
     */
    public static function cast($sourceObject) {
        $destination = new Kneipe();
        $sourceReflection = new ReflectionObject($sourceObject);
        $destinationReflection = new ReflectionObject($destination);
        $sourceProperties = $sourceReflection->getProperties();
        foreach ($sourceProperties as $sourceProperty) {
            $sourceProperty->setAccessible(true);
            $name = $sourceProperty->getName();
            $value = $sourceProperty->getValue($sourceObject);
            if ($destinationReflection->hasProperty($name)) {
                $propDest = $destinationReflection->getProperty($name);
                $propDest->setAccessible(true);
                $propDest->setValue($destination,$value);
            } else {
                $destination->$name = $value;
            }
        }

        return $destination;
    }

}

?>
